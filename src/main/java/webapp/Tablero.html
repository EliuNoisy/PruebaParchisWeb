<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tablero de Juego</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kufam:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/Tablero.css"/>
    
    <style>
        /* ESTILOS ADICIONALES PARA WEBSOCKET */
        .modal-conexion {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 10000;
            text-align: center;
        }
        .modal-conexion h2 {
            margin-bottom: 20px;
            color: #667eea;
        }
        .modal-conexion input {
            width: 200px;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #667eea;
            border-radius: 8px;
            margin: 15px 0;
        }
        .modal-conexion button {
            padding: 12px 40px;
            font-size: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .status-conexion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .status-conexion.conectado { color: #4CAF50; border: 2px solid #4CAF50; }
        .status-conexion.desconectado { color: #F44336; border: 2px solid #F44336; }
        
        .panel-acciones {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.98);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            display: none;
            gap: 20px;
            align-items: center;
            z-index: 1000;
        }
        .btn-dado {
            padding: 15px 35px;
            font-size: 18px;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-dado:disabled { background: #ccc; cursor: not-allowed; }
        .resultado-dado {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            animation: girar 0.5s;
        }
        @keyframes girar {
            from { transform: rotate(0deg) scale(0); }
            to { transform: rotate(360deg) scale(1); }
        }
        .ficha.disponible {
            animation: pulsar 1s infinite;
            border: 3px solid #FFD700 !important;
            box-shadow: 0 0 20px #FFD700 !important;
            cursor: pointer !important;
        }
        @keyframes pulsar {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.2); }
        }
        .mensaje-accion {
            font-weight: bold;
            color: #667eea;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- MODAL DE CONEXIÃ“N -->
    <div class="modal-conexion" id="modalConexion">
        <h2>ðŸŽ² Conectar al Servidor</h2>
        <input type="number" id="puertoInput" placeholder="Puerto (ej: 56584)" value="56584">
        <br><br>
        <button onclick="conectarServidor()">Conectar</button>
    </div>

    <!-- STATUS DE CONEXIÃ“N -->
    <div class="status-conexion desconectado" id="statusConexion">
        âš« Desconectado
    </div>

    <div class="encabezado-juego">
        <div class="seccion-tiempo">
            <div class="etiqueta-tiempo">Tiempo Restante</div>
            <div class="barra-tiempo">
                <div class="progreso-tiempo" id="barraProgreso"></div>
            </div>
        </div>
        <button class="boton-config-juego" id="botonCoord">
            <img src="assets/Confi.png" alt="ConfiguraciÃ³n"/>
        </button>
    </div>

    <div class="contenedor-juego">
        <!-- Contenedor Izquierda: Jugadores 1 y 3 -->
        <div class="contenedor-izquierda">
            <div class="jugador-lateral" data-jugador="1" data-color="amarillo">
                <div class="flecha-jugador">â†“</div>
                <div class="avatar-lateral">
                    <img src="assets/1.jpg" alt="Jugador 1">
                </div>
                <div class="nombre-lateral">Jugador 1</div>
                <div class="dados-jugador">
                    <div class="dado" id="dadoJ1">
                        <img class="dado" src="assets/D1.jpg" alt="Dado"/>
                    </div>
                </div>
            </div>

            <div class="jugador-lateral" data-jugador="3" data-color="rojo">
                <div class="flecha-jugador">â†“</div>
                <div class="avatar-lateral">
                    <img src="assets/2.jpg" alt="Jugador 3">
                </div>
                <div class="nombre-lateral">Jugador 3</div>
                <div class="dados-jugador">
                    <div class="dado" id="dadoJ3">
                        <img class="dado" src="assets/D1.jpg" alt="Dado"/>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tablero Central -->
        <div class="contenedor-tablero">
            <div id="debug-container"></div>
            <img src="assets/Foto tablero.png" alt="Tablero" class="imagen-tablero" id="imagenTablero">
            <div class="capa-casillas" id="capaCasillas"></div>
        </div>

        <!-- Contenedor Derecha: Jugadores 2 y 4 -->
        <div class="contenedor-derecha">
            <div class="jugador-lateral" data-jugador="2" data-color="azul">
                <div class="flecha-jugador">â†“</div>
                <div class="avatar-lateral">
                    <img src="assets/3.jpg" alt="Jugador 2">
                </div>
                <div class="nombre-lateral">Jugador 2</div>
                <div class="dados-jugador">
                    <div class="dado" id="dadoJ2">
                        <img class="dado" src="assets/D1.jpg" alt="Dado"/>
                    </div>
                </div>
            </div>

            <div class="jugador-lateral" data-jugador="4" data-color="verde">
                <div class="flecha-jugador">â†“</div>
                <div class="avatar-lateral">
                    <img src="assets/4.jpg" alt="Jugador 4">
                </div>
                <div class="nombre-lateral">Jugador 4</div>
                <div class="dados-jugador">
                    <div class="dado" id="dadoJ4">
                        <img class="dado" src="assets/D1.jpg" alt="Dado"/>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PANEL DE ACCIONES -->
    <div class="panel-acciones" id="panelAcciones">
        <button class="btn-dado" id="btnLanzarDado" onclick="lanzarDado()">
            ðŸŽ² Lanzar Dado
        </button>
        <div class="resultado-dado" id="resultadoDado"></div>
        <div class="mensaje-accion" id="mensajeAccion"></div>
    </div>

    <script>
        // ==================== VARIABLES GLOBALES ====================
        let ws = null;
        let partidaActiva = false;
        let esperandoSeleccion = false;
        let fichasDisponiblesActual = [];
        const jugadoresConectados = 2;

        // Mapeo de colores Java -> HTML
        const mapaColores = {
            'Amarillo': 'amarillo',
            'Azul': 'azul',
            'Rojo': 'rojo',
            'Verde': 'verde'
        };

        // COORDENADAS DE LAS BASES
        const coordenadasBases = {
            verde: [
                {x: 13.7, y: 13.7},
                {x: 26.5, y: 13.7},
                {x: 13.7, y: 26.6},
                {x: 26.5, y: 26.6}
            ],
            amarillo: [
                {x: 73.7, y: 13.8},
                {x: 86.5, y: 13.8},
                {x: 73.7, y: 26.5},
                {x: 86.5, y: 26.6}
            ],
            rojo: [
                {x: 13.6, y: 86.4},
                {x: 13.6, y: 73.7},
                {x: 26.5, y: 86.4},
                {x: 26.5, y: 73.5}
            ],
            azul: [
                {x: 73.7, y: 73.8},
                {x: 86.5, y: 73.8},
                {x: 73.7, y: 86.4},
                {x: 86.5, y: 86.4}
            ]
        };

        // COORDENADAS DEL TABLERO
        const casillas = [
            {id: 5, x: 56.6, y: 89.5},   // Salida Amarillo
            {id: 6, x: 56.8, y: 82.9},
            {id: 7, x: 56.8, y: 76.2},
            {id: 8, x: 56.6, y: 69.7},
            {id: 9, x: 56.6, y: 63.1},
            {id: 10, x: 62.6, y: 57.0},
            {id: 11, x: 69.7, y: 57.0},
            {id: 12, x: 76.1, y: 56.2},
            {id: 13, x: 82.4, y: 57.0},
            {id: 14, x: 89.1, y: 56.4},
            {id: 15, x: 95.7, y: 56.4},
            {id: 16, x: 96.1, y: 50.4},
            {id: 17, x: 96.1, y: 43.1},
            {id: 18, x: 89.3, y: 43.3},
            {id: 19, x: 82.6, y: 43.7},
            {id: 20, x: 75.9, y: 43.5},
            {id: 21, x: 69.3, y: 43.5},
            {id: 22, x: 63.2, y: 43.3},  // Salida Azul
            {id: 23, x: 56.4, y: 37.0},
            {id: 24, x: 56.1, y: 30.0},
            {id: 25, x: 56.6, y: 23.7},
            {id: 26, x: 56.8, y: 17.4},
            {id: 27, x: 56.6, y: 10.4},
            {id: 28, x: 56.4, y: 4.1},
            {id: 29, x: 49.1, y: 3.7},
            {id: 30, x: 43.2, y: 4.3},
            {id: 31, x: 42.8, y: 10.0},
            {id: 32, x: 43.0, y: 17.0},
            {id: 33, x: 42.8, y: 23.3},
            {id: 34, x: 43.0, y: 29.9},
            {id: 35, x: 43.7, y: 37.0},
            {id: 36, x: 36.4, y: 42.5},
            {id: 37, x: 30.1, y: 43.1},
            {id: 38, x: 24.5, y: 43.1},
            {id: 39, x: 16.4, y: 42.7},  // Salida Verde
            {id: 40, x: 10.7, y: 43.3},
            {id: 41, x: 3.4, y: 43.1},
            {id: 42, x: 3.9, y: 49.3},
            {id: 43, x: 4.3, y: 56.4},
            {id: 44, x: 10.1, y: 56.8},
            {id: 45, x: 17.0, y: 57.0},
            {id: 46, x: 23.4, y: 56.4},
            {id: 47, x: 29.9, y: 56.6},
            {id: 48, x: 36.6, y: 56.8},
            {id: 49, x: 43.2, y: 63.1},
            {id: 50, x: 43.0, y: 69.7},
            {id: 51, x: 42.8, y: 76.4},
            {id: 52, x: 43.4, y: 82.9},
            {id: 53, x: 43.4, y: 89.3},
            {id: 54, x: 43.6, y: 95.8},
            {id: 55, x: 50.1, y: 95.6},
            {id: 56, x: 10.7, y: 43.3},  // Salida Rojo
            {id: 67, x: 50.0, y: 50.0}   // Meta
        ];

        // Convertir a mapa para bÃºsqueda rÃ¡pida
        const coordenadasTablero = {};
        casillas.forEach(c => {
            coordenadasTablero[c.id] = {x: c.x, y: c.y};
        });

        // ==================== WEBSOCKET ====================
        function conectarServidor() {
            const puerto = document.getElementById('puertoInput').value;
            const url = `ws://localhost:${puerto}`;

            console.log('ðŸ”Œ Conectando a:', url);
            ws = new WebSocket(url);

            ws.onopen = function() {
                console.log('âœ… Conectado');
                document.getElementById('modalConexion').style.display = 'none';
                document.getElementById('statusConexion').textContent = 'ðŸŸ¢ Conectado';
                document.getElementById('statusConexion').className = 'status-conexion conectado';
                iniciarPartida();
            };

            ws.onmessage = function(event) {
                const datos = JSON.parse(event.data);
                console.log('ðŸ“¨ Recibido:', datos);
                procesarMensaje(datos);
            };

            ws.onerror = function(error) {
                console.error('âŒ Error:', error);
                alert('Error de conexiÃ³n');
            };

            ws.onclose = function() {
                console.log('ðŸ”´ Desconectado');
                document.getElementById('statusConexion').textContent = 'âš« Desconectado';
                document.getElementById('statusConexion').className = 'status-conexion desconectado';
            };
        }

        function procesarMensaje(datos) {
            switch(datos.tipo) {
                case 'PARTIDA_INICIADA':
                    partidaActiva = true;
                    document.getElementById('panelAcciones').style.display = 'flex';
                    mostrarMensaje('Â¡Partida iniciada!');
                    crearFichasDesdeEstado(datos.estado.jugadores);
                    break;

                case 'RESULTADO_DADO':
                    mostrarResultadoDado(datos.valor);
                    fichasDisponiblesActual = datos.fichasDisponibles || [];
                    
                    if (fichasDisponiblesActual.length > 0) {
                        iluminarFichasDisponibles(fichasDisponiblesActual);
                        mostrarMensaje('Selecciona una ficha');
                        esperandoSeleccion = true;
                    } else {
                        mostrarMensaje('Sin fichas disponibles');
                        setTimeout(() => {
                            document.getElementById('btnLanzarDado').disabled = false;
                        }, 2000);
                    }
                    break;

                case 'MOVIMIENTO_RESULTADO':
                    if (datos.exito) {
                        actualizarTablero(datos.estadoJuego);
                        mostrarMensaje('âœ… Movimiento exitoso');
                        esperandoSeleccion = false;
                        document.getElementById('btnLanzarDado').disabled = false;
                    }
                    break;
            }
        }

        function iniciarPartida() {
            enviarMensaje({ accion: 'INICIAR_PARTIDA' });
        }

        function lanzarDado() {
            if (!partidaActiva) return;
            document.getElementById('btnLanzarDado').disabled = true;
            document.getElementById('resultadoDado').textContent = '';
            enviarMensaje({ accion: 'LANZAR_DADO' });
        }

        function moverFicha(fichaId, pasos) {
            enviarMensaje({
                accion: 'MOVER_FICHA',
                fichaId: fichaId,
                pasos: pasos
            });
        }

        function enviarMensaje(datos) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(datos));
            }
        }

        // ==================== INTERFAZ ====================
        function mostrarResultadoDado(valor) {
            const elemento = document.getElementById('resultadoDado');
            elemento.textContent = 'ðŸŽ² ' + valor;
        }

        function mostrarMensaje(texto) {
            document.getElementById('mensajeAccion').textContent = texto;
        }

        function crearFichasDesdeEstado(jugadores) {
            const capa = document.getElementById('capaCasillas');
            capa.innerHTML = '';

            jugadores.forEach(jugador => {
                const colorHTML = mapaColores[jugador.color] || 'amarillo';
                
                jugador.fichas.forEach(ficha => {
                    const elementoFicha = document.createElement('div');
                    elementoFicha.className = `ficha ${colorHTML}`;
                    elementoFicha.dataset.fichaId = ficha.id;
                    elementoFicha.dataset.color = colorHTML;
                    
                    const estrella = document.createElement('div');
                    estrella.className = 'estrella-ficha';
                    estrella.textContent = 'â˜…';
                    elementoFicha.appendChild(estrella);
                    
                    posicionarFicha(elementoFicha, ficha, colorHTML);
                    
                    elementoFicha.addEventListener('click', function() {
                        if (esperandoSeleccion && this.classList.contains('disponible')) {
                            const fichaId = parseInt(this.dataset.fichaId);
                            quitarIluminacion();
                            moverFicha(fichaId, 0);
                        }
                    });
                    
                    capa.appendChild(elementoFicha);
                });
            });
        }

        function posicionarFicha(elemento, ficha, color) {
            let coords;
            
            if (ficha.enCasa) {
                const baseIndex = (ficha.id - 1) % 4;
                coords = coordenadasBases[color][baseIndex];
            } else if (ficha.enMeta) {
                coords = coordenadasTablero[67] || {x: 50, y: 50};
            } else {
                coords = coordenadasTablero[ficha.posicion] || {x: 50, y: 50};
            }
            
            elemento.style.left = coords.x + '%';
            elemento.style.top = coords.y + '%';
        }

        function iluminarFichasDisponibles(fichas) {
            quitarIluminacion();
            fichas.forEach(f => {
                const elemento = document.querySelector(`[data-ficha-id="${f.idFicha}"]`);
                if (elemento) {
                    elemento.classList.add('disponible');
                }
            });
        }

        function quitarIluminacion() {
            document.querySelectorAll('.ficha.disponible').forEach(f => {
                f.classList.remove('disponible');
            });
        }

        function actualizarTablero(estadoJuego) {
            crearFichasDesdeEstado(estadoJuego.jugadores);
        }

        // ==================== FUNCIONES ORIGINALES ====================
        function obtenerColoresActivos() {
            const ordenColores = ['verde', 'amarillo', 'rojo', 'azul'];
            return ordenColores.slice(0, jugadoresConectados);
        }

        function configurarJugadores() {
            const todosJugadores = document.querySelectorAll('.jugador-lateral');
            todosJugadores.forEach(j => j.style.display = 'none');

            for (let i = 1; i <= jugadoresConectados; i++) {
                const jugador = document.querySelector(`[data-jugador="${i}"]`);
                if (jugador) {
                    jugador.style.display = 'flex';
                }
            }
        }

        function mostrarCoordenadasDebug() {
            const debug = document.getElementById("debug-container");
            debug.innerHTML = "";

            casillas.forEach(c => {
                const dot = document.createElement("div");
                dot.classList.add("debug-dot");
                dot.style.left = c.x + "%";
                dot.style.top = c.y + "%";
                dot.title = `Casilla ${c.id}`;
                dot.textContent = c.id;
                debug.appendChild(dot);
            });
        }

        function toggleModoCoordernadas() {
            const debug = document.getElementById('debug-container');
            debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
        }

        let tiempoRestante = 100;
        function actualizarTiempo() {
            const barra = document.getElementById('barraProgreso');
            tiempoRestante -= 2.0;
            if (tiempoRestante < 0) tiempoRestante = 100;
            barra.style.width = tiempoRestante + '%';

            if (tiempoRestante < 30) {
                barra.style.background = 'linear-gradient(90deg, #F44336 0%, #FF5722 100%)';
            } else if (tiempoRestante < 60) {
                barra.style.background = 'linear-gradient(90deg, #FFC107 0%, #FFD54F 100%)';
            } else {
                barra.style.background = 'linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%)';
            }
        }

        // INICIALIZAR
        configurarJugadores();
        mostrarCoordenadasDebug();
        setInterval(actualizarTiempo, 1000);
        document.getElementById('botonCoord').addEventListener('click', toggleModoCoordernadas);
    </script>
</body>
</html>